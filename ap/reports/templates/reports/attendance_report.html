{% extends "base.html" %}
{% load staticfiles %}
{% load bootstrap3 %}

{% block title %} Attendance Report {% endblock %}

{% block scripts %}
<script type="text/javascript">

var attendance_records = [];
var date_from = "{{date_from}}";
var date_to = "{{date_to}}";
var trainee_ids = {{trainee_ids}};

var average_uap = 0
var average_sp = 0
var average_tp = 0
var average_cmp = 0

function update_progress(){
  var compute_percentage = Math.round(attendance_records.length / trainee_ids.length * 100)
  $("#progressbar").children().attr("aria-valuenow", compute_percentage).css("width", compute_percentage + "%").text(compute_percentage + "% Complete");
}

function append_response(trainee_info){
  var trainee_record = document.createElement("tr");
  var col = document.createElement("td");
  col.innerHTML = trainee_info["lastname"] + ', ' + trainee_info["firstname"]
  trainee_record.append(col)

  col = document.createElement("td");
  col.innerHTML = trainee_info["ta"]
  trainee_record.append(col)

  col = document.createElement("td");
  col.innerHTML = trainee_info["term"]
  trainee_record.append(col)

  col = document.createElement("td");
  col.innerHTML = trainee_info["team"]
  trainee_record.append(col)

  col = document.createElement("td");
  col.innerHTML = trainee_info["gender"]
  trainee_record.append(col)

  col = document.createElement("td");
  col.innerHTML = trainee_info["unexcused_absences_percentage"]
  trainee_record.append(col)

  col = document.createElement("td");
  col.innerHTML = trainee_info["tardy_percentage"]
  trainee_record.append(col)

  col = document.createElement("td");
  col.innerHTML = trainee_info["sickness_percentage"]
  trainee_record.append(col)

  col = document.createElement("td");
  col.innerHTML = trainee_info["classes_missed_percentage"]
  trainee_record.append(col)

  table_id = "locality-" + trainee_info["sending_locality"]
  $("#"+table_id).children("tbody").append(trainee_record)

  append_team(trainee_record.cloneNode(true), trainee_info)

}

function append_team(constructed_row, trainee_info){
  l_id = trainee_info["sending_locality"]
  locality = $("#locality-"+l_id).prev().children().first().text()
  col = constructed_row.children.item(3)
  col.innerHTML = locality

  table_id = "team-" + trainee_info["team"]
  $("#"+table_id).children("tbody").append(constructed_row)

}

function send_averages(){
}

function get_trainee_record(trainee_id){
	$.ajax({
      type: "GET",
      url: "{% url 'reports:attendance-report-individual-trainee' %}",
      data: {
      	t_id: trainee_id,
      },
      success: function(response){
          attendance_records.push(response)
          append_response(response)
          update_progress()
          average_uap = average_uap + parseFloat(response['unexcused_absences_percentage'])
          average_sp = average_sp + parseFloat(response['sickness_percentage'])
          average_tp = average_tp + parseFloat(response['tardy_percentage'])
          average_cmp = average_cmp + parseFloat(response['classes_missed_percentage'])

          if (attendance_records.length == trainee_ids.length){
            average_uap = (Math.round((average_uap / attendance_records.length) * 100) / 100).toFixed(2) + "%"
            average_sp = (Math.round((average_sp / attendance_records.length) * 100) / 100).toFixed(2) + "%"
            average_tp = (Math.round((average_tp / attendance_records.length) * 100) / 100).toFixed(2) + "%"
            average_cmp = (Math.round((average_cmp / attendance_records.length) * 100) / 100).toFixed(2) + "%"

            var list = document.createElement("ul")
            var item1 = document.createElement("li")
            item1.innerHTML = "average unexcused absences: " + average_uap
            list.append(item1)

            var item2 = document.createElement("li")
            item2.innerHTML = "average sickness: " + average_sp
            list.append(item2)

            var item3 = document.createElement("li")
            item3.innerHTML = "average tardy: " + average_tp
            list.append(item3)

            var item4 = document.createElement("li")
            item4.innerHTML = "average classes missed: " + average_cmp
            list.append(item4)

            $("#averages").append(list)
            send_averages()

            console.log("complete")
            $("#navigation_bar").show()
            $(".tab-content").show()
            $(".progress-bar").removeClass("active")
          }
        },
      })
};



$( document ).ready(() => {
	trainee_ids.forEach(function(element) {
		get_trainee_record(element);
	});
  $("#navigation_bar").hide()
  $(".tab-content").hide()
  $( "body" ).on('click', '#zip_download_link', function(){
    window.open("{% url 'reports:zip-attendance-report' %}", '_blank')
  })
})



</script>
{% endblock %}

{% block references %}
<style type="text/css">

</style>
{% endblock %}

{% block content %}

<div id="progressbar" class="progress">
  <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em;">0%
  </div>
</div>

<div id="averages">
</div>


<ul id="navigation_bar" class="nav nav-tabs" role="tablist">
  <li role="presentation" class="active"><a href="#sending_locality" role="tab" data-toggle="tab">By Locality</a></li>
  <li role="presentation"><a href="#serving_team" role="tab" data-toggle="tab">By Team</a></li>
  <li role="presentation"><a id="zip_download_link" href="#zip_download" role="tab" data-toggle="tab">Download Zip File</a></li>
</ul>

<div class="tab-content">
  <div id="sending_locality" class="tab-pane active" role="tabpanel" >

    {% for locality in localities %}
    <div class="panel-body">
      <h2><span class="locality-name">{{ locality.name }}</span> Sending Locality Generated Report from {{date_from}} to {{date_to}} </h2>
      <table id="locality-{{locality.id}}" class="table table-striped">
        <thead><tr>
          <th>Trainee</th>
          <th>TA</th>
          <th>Term</th>
          <th>Team</th>
          <th>Gender</th>
          <th>% Unex. Abs.</th>
          <th>% Tardy</th>
          <th>% Sickness</th>
          <th>% Classess Missed</th>

        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
    {% endfor %}

  </div>

  <div id="serving_team" class="tab-pane active" role="tabpanel" >
    {% for team in teams %}
    <div class="panel-body">
      <table id="team-{{team}}" class="table table-striped">
        <h2> {{ team }} Team Generated Report from {{date_from}} to {{date_to}} </h2>
        <thead><tr>
          <th>Trainee</th>
          <th>TA</th>
          <th>Term</th>
          <th>Sending Locality</th>
          <th>Gender</th>
          <th>% Unex. Abs.</th>
          <th>% Tardy</th>
          <th>% Sickness</th>
          <th>% Classess Missed</th>

        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
    {% endfor %}
  </div>

  <div id="zip_download" class="tab-pane active" role="tabpanel" >
  </div>
  {% endblock %}


