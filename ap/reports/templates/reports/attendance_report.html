{% extends "base.html" %}
{% load staticfiles %}
{% load bootstrap3 %}

{% block title %} Attendance Report {% endblock %}

{% block scripts %}
<script type="text/javascript">

var attendance_records = [];
var date_from = "{{date_from}}";
var date_to = "{{date_to}}";
var trainee_ids = {{trainee_ids}};

function update_progress(){
  var compute_percentage = Math.round(attendance_records.length / trainee_ids.length * 100)
  $("#progressbar").children().attr("aria-valuenow", compute_percentage).css("width", compute_percentage + "%").text(compute_percentage + "% Complete");
}

function get_trainee_record(trainee_id){
	$.ajax({
      type: "GET",
      url: "{%url 'reports:attendance-report-individual-trainee' %}",
      data: {
      	t_id: trainee_id,
      	date_from: date_from,
      	date_to: date_to,
      },
      success: function(response){
          attendance_records.push(response)
          var trainee_record = document.createElement("tr");
          var col = document.createElement("td");
          col.innerHTML = response["lastname"] + ', ' + response["firstname"]
          trainee_record.append(col)

          col = document.createElement("td");
          col.innerHTML = response["ta"]
          trainee_record.append(col)

          col = document.createElement("td");
          col.innerHTML = response["term"]
          trainee_record.append(col)

          col = document.createElement("td");
          col.innerHTML = response["team"]
          trainee_record.append(col)

          col = document.createElement("td");
          col.innerHTML = response["gender"]
          trainee_record.append(col)

          col = document.createElement("td");
          col.innerHTML = response["% Unex. Abs."]
          trainee_record.append(col)

          col = document.createElement("td");
          col.innerHTML = response["% Tardy"]
          trainee_record.append(col)

          col = document.createElement("td");
          col.innerHTML = response["% Sickness"]
          trainee_record.append(col)

          col = document.createElement("td");
          col.innerHTML = response["% Classes Missed"]
          trainee_record.append(col)

          table_id = "locality-" + response["sending_locality"]
          $("#"+table_id).children("tbody").append(trainee_record)
          update_progress()


          if (attendance_records.length == trainee_ids.length){
            console.log("complete")
          }
        },
      })
};

$( document ).ready(() => {
	trainee_ids.forEach(function(element) {
		get_trainee_record(element);
	});


});

</script>
{% endblock %}

{% block references %}
<style type="text/css">

</style>
{% endblock %}

{% block content %}

<div class="progress" id="progressbar">
  <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em;">0%
  </div>
</div>

{% for locality in localities %}

<div class="panel-body">
  <table id="locality-{{locality.id}}" class="table table-striped">
    <h2> {{ locality.name }} Sending Locality Generated Report from {{date_from}} to {{date_to}} </h2>
    <thead><tr>
      <th>Trainee</th>
      <th>TA</th>
      <th>Term</th>
      <th>Team</th>
      <th>Gender</th>
      <th>% Unex. Abs.</th>
      <th>% Tardy</th>
      <th>% Sickness</th>
      <th>% Classess Missed</th>

    </tr></thead>
    <tbody></tbody>
  </table>
</div>
{% endfor %}

{% endblock %}


